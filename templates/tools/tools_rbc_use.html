{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block content %}
<div class="container">
    <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a class="text-decoration-none" href="{% url 'tools:tools_list' %}">工具列表</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ tools_id }}</li>
        </ol>
    </nav>
    <div class="row form-control mt-3 pt-3">
        <div class="col">
            <h4 class="panel-title">使用方法：</h4>
        </div>
        <div class="row pt-3">
            <div class="col">
                <div class="panel-body">
                     进行分析前，请按以下步骤操作以确保您的数据能够被正确处理：
                    <ul>
                        <li><strong>填写项目名称</strong>：输入一个无空格、可识别且唯一的项目名称。</li>
                        <li><strong>选择数据</strong>：如果未找到所需数据，请点击刷新按钮尝试更新数据列表。</li>
                        <li><strong>选择或添加Panel</strong>：从已有的Panel中选择一个，或通过点击“添加新Panel”按钮添加新的Panel,在管理panel按钮中下载或删除已有panel。</li>
                        <li><strong>提交任务</strong>：完成以上步骤后，点击“开始分析”按钮提交您的任务。</li>
                        <li><strong>查看结果状态</strong>：通过<a class="text-decoration-none" href="{% url 'tools:check_status' tools_id=tools_id %}" title="查看以往分析状态">以往状态查询</a>查询以往的状态和结果。</li>
                    </ul>
                    注意：确保所有步骤都按顺序完成，以避免处理过程中出现错误。
                </div>
            </div>
        </div>
    </div>
   <div class="row form-control mt-3 pt-3">
        <form id="uploadForm" class="form-group" method="post">{% csrf_token %}

            <!-- project name -->
            <div class="mb-4 pt-3">
                <label for="" class="form-label">Project Name:</label>
                <input type="text" class="form-control" placeholder="test"
                    name="project_name" required="required" pattern="[^\s]+" title="Project Name should not contain spaces"/>
            </div>

            <!-- NGS data -->
            <div class="mb-4 pt-3">
                <label for="formFile1" class="form-label">NGS data path</label>
                <select class="form-select" id="path_select" name="path_select">
                    <option value="" selected>Choose Folder Name</option>
                    {% for file in available_files %}
                        <option value="{{ file.data_name }}">
                            {{ file.data_name }}({{ file.fq_count }})
                        </option>
                    {% endfor %}
               </select>
               <span>未找到? <a href="{% url 'tools:update_data_path' %}" id="update-data-link"><i class="bi bi-arrow-clockwise"></i></a></span>
            </div>

            <!-- Add new panel -->
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="text-success">Commonly used panel at Wehelp</h5>
                <div class="d-flex">
                    <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#panelModal">
                        <i class="bi bi-plus-circle me-2"></i>Add new panel
                    </button>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#managePanelModal">
                        <i class="bi bi-gear-fill me-2"></i>Manage panel
                    </button>
                </div>
            </div>

            <!-- 模态框 1 添加新panel-->
            <div class="modal fade" id="panelModal" tabindex="-1" aria-labelledby="panelModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="panelModalLabel">Add New Panel</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- 表单 -->
                            <form>
                            <div class="mb-3">
                                <label for="panelName" class="form-label">Panel Name</label>
                                <input type="text" class="form-control" id="panelName" placeholder="Enter panel name">
                            </div>
                            <div class="mb-3">
                                <label for="panelFile" class="form-label">Upload File</label>
                                <input type="file" class="form-control" id="panelFile">
                            </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="savePanelBtn">Upload</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 模态框 2 管理panel-->
            <div class="modal fade" id="managePanelModal" tabindex="-1" aria-labelledby="managePanelModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="managePanelModalLabel">Manage Panels</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th scope="col">Panel Name</th>
                                        <th scope="col">Download</th>
                                        <th scope="col">Delete</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for panel in panel_list %}
                                    <tr>
                                        <td>{{ panel.name }}</td>
                                        <td><a href="{% url 'tools:download_file' panel.panel_file %}" class="link-underline link-underline-opacity-0">{{ panel.panel_file.name|basename }}</a></td>
                                        <td>
                                            <a class="delete-item-btn" data-url="{% url 'tools:panel_delete' panel.id %}" 
                                                data-id="{{ panel.id }}">
                                                <i class="bi bi-trash" style="color:red"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Select Panel -->
            <select class="form-select mt-2" size="5" id="panel_id">
                <option value="" selected >Choose a panel</option>
                {% for panel in panel_list %}
                    <option value="{{ panel.id }}" class="text-success">{{ panel.name }} -- {{ panel.panel_file.name|basename }}</option>
                {% endfor %}
            </select>

            <!-- button -->
            <div class="col-xs-7 mb-3 mt-5">
                <button type="button" class="btn btn-primary" id="analysisButton">Start Analysis</button>
            </div>
        </form>
        <!-- Delete panel modal -->
        {% include 'deleteModal.html' %}
    </div>
</div>
{% endblock %}

{% block javascript %}
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('analysisButton').addEventListener('click', function () {

            event.preventDefault();
            console.log('form submitted');

            // 收集数据
            let projectName = document.getElementsByName('project_name')[0].value;
            if (!projectName || projectName === "") {
                alert("请输入项目名称！");
                return; // 阻止表单提交
            };

            // 检查下拉框是否选择了非默认值
            let selectedPath = document.getElementById('path_select').value;
            if (!selectedPath || selectedPath === "") {
                alert("请选择一个有效的数据路径！");
                return; // 阻止表单提交
            };

            let panel = document.getElementById('panel_id');
            let panel_id = panel.options[panel.selectedIndex].value;
            console.log("panel_id: ", panel_id);
            if (!panel_id || panel_id === "") {
                alert("请选择一个有效的panel！");
                return; // 阻止表单提交
            };

            let formData = {
                projectName: projectName,
                selectedPath: selectedPath,
                panel_id: panel_id
            };

            // 发送 AJAX 请求
            fetch("{% url 'tools:tools_use' 'rbc' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                    console.log('提交成功:', data);
                    if (data.status === 'success') {
                        // 处理成功的响应，例如刷新页面或跳转
                        alert("任务提交成功!,将跳转到状态查询页！")
                        window.location.href = '/tools/check_status/rbc/'; // 跳转到另一个页面
                    }
                    else {
                        // 处理失败的响应
                        console.error('Error:', data);
                        alert("任务提交失败，请联系管理员启动异步服务!,错误信息：" + data.message);
                    }
            })
            .catch(error => console.error('Error:', error));
        });
    });

    // upload new panel.
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('savePanelBtn').addEventListener('click', function () {
            var panelName = document.getElementById('panelName').value;
            var panelFile = document.getElementById('panelFile').files[0];

            if (!panelName || !panelFile) {
                alert('Please enter a panel name and select a file.');
                return;
            }

            var formData = new FormData();
            formData.append('panel_name', panelName);
            formData.append('panel_file', panelFile);

            fetch('/tools/panel_upload/', { // 替换为你的服务器端URL
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Panel uploaded successfully');
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while uploading the panel.');
            });
        });
    });

    // refresh data selection.
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('update-data-link').addEventListener('click', function(event) {
            event.preventDefault();

            // AJAX 请求
            $.ajax({
                url: "{% url 'tools:update_data_path' %}", // 后端处理的 URL
                type: "POST", // 数据提交方式
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                data: JSON.stringify({data_type: 'rbc'}), // 要发送的数据
                success: function(data) {
                    if (data.status === 'success'){

                        alert("刷新成功！");  // 显示成功提示
                        // 刷新页面
                        window.location.reload();
                    } else {
                        console.error('no files data in response');
                        alert("刷新失败，请稍后再试。");  // 显示错误提示
                    }
                },
                error: function(xhr, errmsg, err) {
                    console.error('Error:', xhr, errmsg, err);
                    alert("刷新失败，请稍后再试。");  // 显示错误提示
                }
            });
        });
    });

    // 获取 CSRF token 的函数
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // 删除项目
    function del_item(the, id) {
        var deleteUrl = $(the).data('url');
        console.log(deleteUrl);
        layer.open({
            type: 1,
            skin: 'layui-layer-rim',
            area: ['420px', '240px'],
            title: 'Delete',
            content: '<div style="padding: 20px 80px;">Are you sure to delete this item?</div>',
            btn: ['Yes', 'No'],
            btnAlign: 'c',
            yes: function (index, layero) {
                $.ajax({
                    url: deleteUrl,
                    type: "POST",
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'id': id,
                    },
                    dataType: "json",
                    success: function (data) {
                        if (data.status === 'success') {
                            layer.msg('Delete successfully!', { icon: 1 });
                            setTimeout(function () {
                                window.location.reload();
                            }, 1000);
                        } else {
                            layer.msg(data.message, { icon: 2 });
                        }
                    },
                    error: function (xhr, errmsg, err) {
                        layer.msg('Delete failed!', { icon: 2 });
                    }
                });
            },
        })
    }
</script>
{% endblock %}

